#!/usr/bin/env bash
set -euo pipefail
ROOT="${HOME}/jarvis"
SNAPS="${ROOT}/snaps"
mkdir -p "$SNAPS"
TS="$(date +"%Y%m%d-%H%M%S")"
OUT="$SNAPS/heavy-$TS.txt"
{
  echo "=== date ==="; date
  echo "=== uptime ==="; uptime
  echo "=== swap ==="; sysctl vm.swapusage
  echo "=== vm_stat ==="; vm_stat
  echo "=== memory_pressure ==="; memory_pressure
  echo "=== disk / ==="; df -h /
  echo "=== top mem ==="; (top -l 1 -o mem | head -60) || true
  echo "=== ps rss/vsz ==="; (ps -axo pid,rss,vsz,comm | sort -nrk2 | head -60) || true
  echo "=== kern memory ==="; sysctl kern.memorystatus_level vm.page_free_count vm.page_speculative_count 2>/dev/null || true
  echo "=== log memory last 10m ==="
  (log show --last 10m --predicate 'eventMessage CONTAINS[c] "memory" AND NOT eventMessage CONTAINS "not memory-managed"' --style compact 2>/dev/null | egrep -v "Ignoring jetsam|Ignoring memory limit" | head -200) || true
  echo "=== log jetsam last 10m ==="
  (log show --last 10m --predicate 'eventMessage CONTAINS[c] "jetsam" AND eventMessage CONTAINS "kill"' --style compact 2>/dev/null | head -100) || true
} > "$OUT"
echo "$OUT"
